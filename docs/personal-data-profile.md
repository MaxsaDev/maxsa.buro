# –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è —Ä–æ–∑—Ä–æ–±–∫–∏

## üìã –û–≥–ª—è–¥ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É

–†–æ–∑—Ä–æ–±–ª–µ–Ω–æ –ø–æ–≤–Ω–∏–π —Ü–∏–∫–ª —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –ø—Ä–æ—Ñ—ñ–ª—ñ:

- –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö (–ø–æ–≤–Ω–µ —ñ–º'—è + –∫–æ–Ω—Ç–∞–∫—Ç–∏) –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –≤—Ö–æ–¥—ñ
- –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–æ–≤–Ω–æ–≥–æ —ñ–º–µ–Ω—ñ
- –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤
- –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
- –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü—ñ

#### `mx_data.user_data`

–ó–±–µ—Ä—ñ–≥–∞—î –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:

- `id` (uuid, PK)
- `user_id` (uuid, FK ‚Üí user.id)
- `full_name` (text) - –ø–æ–≤–Ω–µ —ñ–º'—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é
- `created_at`, `updated_at`

#### `mx_data.user_contact`

–ó–±–µ—Ä—ñ–≥–∞—î –∫–æ–Ω—Ç–∞–∫—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:

- `id` (uuid, PK)
- `user_id` (uuid, FK ‚Üí user.id)
- `contact_type_id` (integer, FK ‚Üí mx_dic.dic_contact_type.id)
- `contact_value` (text) - –∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—É
- `is_default` (boolean) - –∫–æ–Ω—Ç–∞–∫—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
- `created_at`, `updated_at`

**–Ü–Ω–¥–µ–∫—Å–∏:**

- `user_contact_default_one_per_user_idx` (UNIQUE WHERE is_default = true) - –≥–∞—Ä–∞–Ω—Ç—É—î –æ–¥–∏–Ω –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç

#### `mx_dic.dic_contact_type`

–°–ª–æ–≤–Ω–∏–∫ —Ç–∏–ø—ñ–≤ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤:

- phone, email, telegram, viber, whatsapp, facebook, messenger, instagram

### VIEW

#### `user_data_with_contact_view`

–û–±'—î–¥–Ω—É—î user_data –∑ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.

---

## üîß –¢—Ä–∏–≥–≥–µ—Ä–∏ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó –ë–î

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è `updated_at`

```sql
trg_user_data_bu_set_updated_at
trg_user_contact_bu_set_updated_at
```

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é `mx_global.set_updated_at()`.

### 2. –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤

```sql
fn_user_contact_bi_validate() - BEFORE INSERT/UPDATE
```

- –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–∞–∫—Ç—É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Ç–∏–ø—É
- –ó–∞–±–æ—Ä–æ–Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç–∏–ø—ñ–≤ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤
- –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–Ω–∞—á–µ–Ω–Ω—è (trim)

### 3. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É

```sql
fn_user_contact_bu_maintain_default() - BEFORE UPDATE
```

- –ó–Ω—ñ–º–∞—î `is_default` –∑ —ñ–Ω—à–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤ **–î–û** –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ unique index
- –£–Ω–∏–∫–∞—î race condition

```sql
fn_user_contact_aid_maintain_default() - AFTER INSERT/DELETE
```

- –ü–µ—Ä—à–∏–π –∫–æ–Ω—Ç–∞–∫—Ç ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π
- –ü—Ä–∏ –≤—Å—Ç–∞–≤—Ü—ñ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ ‚Üí —Å–∫–∏–¥–∞—î —ñ–Ω—à—ñ
- –ü—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ ‚Üí –ø—Ä–∏–∑–Ω–∞—á–∞—î –Ω–æ–≤–∏–π

---

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–¥—É

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫

```
/data/
  /mx-data/
    user-data.ts       ‚Üê SQL –∑–∞–ø–∏—Ç–∏ –¥–ª—è user_data
    user-contact.ts    ‚Üê SQL –∑–∞–ø–∏—Ç–∏ –¥–ª—è user_contact
  /mx-dic/
    contact-types.ts   ‚Üê SQL –∑–∞–ø–∏—Ç–∏ –¥–ª—è dic_contact_type

/actions/
  /profile/
    save-personal-data.ts      ‚Üê –ü–µ—Ä–≤–∏–Ω–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
    update-full-name.ts        ‚Üê –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ
    add-contact.ts             ‚Üê –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—É
    set-default-contact.ts     ‚Üê –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ
    delete-contact.ts          ‚Üê –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—É
    get-personal-data.ts       ‚Üê –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
    get-contact-types.ts       ‚Üê –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–∏–ø—ñ–≤

/components/
  /profile/
    personal-data-section.tsx  ‚Üê –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    personal-data-form.tsx     ‚Üê –§–æ—Ä–º–∞ –ø–µ—Ä—à–æ–≥–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
    edit-full-name-form.tsx    ‚Üê –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —ñ–º–µ–Ω—ñ
    add-contact-form.tsx       ‚Üê –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—É
```

### –ü—Ä–∞–≤–∏–ª–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏

#### 1. **data/** - —á–∏—Å—Ç–∞ —Ä–æ–±–æ—Ç–∞ –∑ –ë–î

- –ù–∞–∑–≤–∞ —Ñ–∞–π–ª—É: `/data/[schema-name]/[table-name].ts`
- **–¢—ñ–ª—å–∫–∏ SQL –∑–∞–ø–∏—Ç–∏** - –∂–æ–¥–Ω–æ—ó –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
- –í—Å—ñ INSERT/UPDATE/DELETE **–æ–±–≥–æ—Ä–Ω—É—Ç—ñ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å `client = await pool.connect()`
- `updated_at` **–ù–ï** –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤—Ä—É—á–Ω—É (—î —Ç—Ä–∏–≥–≥–µ—Ä)

```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
export async function setDefaultContact(userId: string, contactId: string) {
  const client = await pool.connect();
  try {
    await client.query('BEGIN');

    const result = await client.query(
      `UPDATE mx_data.user_contact
       SET is_default = true
       WHERE id = $1 AND user_id = $2`,
      [contactId, userId]
    );

    if (result.rowCount === 0) {
      throw new Error('–ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
    }

    await client.query('COMMIT');
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release();
  }
}
```

#### 2. **actions/** - –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞

- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Zod
- –í–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ–π –∑ `/data`
- –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è `ActionStatus`
- `revalidatePath()` –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–µ—à—É

```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
export async function setDefaultContactAction(contactId: string): Promise<ActionStatus> {
  const user = await getCurrentUser();

  if (!user) {
    return { status: 'error', message: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ', code: 'UNAUTHORIZED' };
  }

  if (!contactId) {
    return { status: 'error', message: 'ID –Ω–µ –≤–∫–∞–∑–∞–Ω–æ', code: 'VALIDATION_ERROR' };
  }

  await setDefaultContact(user.id, contactId);
  revalidatePath('/profile');

  return { status: 'success', message: '–ö–æ–Ω—Ç–∞–∫—Ç –∑–º—ñ–Ω–µ–Ω–æ' };
}
```

#### 3. **components/** - UI

- Client Components –¥–ª—è —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
- –ü–µ—Ä–µ–¥–∞—á–∞ callback-—Ñ—É–Ω–∫—Ü—ñ–π –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è shadcn UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ (Item, Card, Button, —Ç–æ—â–æ)

---

## üîÑ Flow —Ä–æ–∑—Ä–æ–±–∫–∏ (–∑–æ–ª–æ—Ç–∏–π —à–ª—è—Ö)

### 1. –ü–µ—Ä–≤–∏–Ω–Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `PersonalDataForm`

**–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:**

1. –í–≤–æ–¥–∏—Ç—å –ø–æ–≤–Ω–µ —ñ–º'—è (—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –∫–∏—Ä–∏–ª–∏—Ü—è)
2. –í–∏–±–∏—Ä–∞—î —Ç–∏–ø(–∏) –∫–æ–Ω—Ç–∞–∫—Ç—É —á–µ—Ä–µ–∑ toggle-–∫–Ω–æ–ø–∫–∏ (phone –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
3. –í–≤–æ–¥–∏—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—É
4. –ù–∞—Ç–∏—Å–∫–∞—î "+" ‚Üí –∫–æ–Ω—Ç–∞–∫—Ç –¥–æ–¥–∞—î—Ç—å—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–∏–π –º–∞—Å–∏–≤
5. –ú–æ–∂–µ –¥–æ–¥–∞—Ç–∏ –±—ñ–ª—å—à–µ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤
6. –ù–∞—Ç–∏—Å–∫–∞—î "–ó–±–µ—Ä–µ–≥—Ç–∏" (–∞–∫—Ç–∏–≤–Ω–∞ –∫–æ–ª–∏: —ñ–º'—è –≤–∞–ª—ñ–¥–Ω–µ + –º—ñ–Ω—ñ–º—É–º 1 –∫–æ–Ω—Ç–∞–∫—Ç)

**–¢–µ—Ö–Ω—ñ—á–Ω–∏–π flow:**

```
PersonalDataForm
  ‚Üì (submit)
savePersonalDataAction
  ‚Üì (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è Zod)
savePersonalDataWithContacts(userId, fullName, contacts[])
  ‚Üì (—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ë–î)
BEGIN
  INSERT INTO user_data (user_id, full_name)
  INSERT INTO user_contact (–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ)
COMMIT
  ‚Üì (—Ç—Ä–∏–≥–≥–µ—Ä)
fn_user_contact_aid_maintain_default() ‚Üí –ø–µ—Ä—à–∏–π –∫–æ–Ω—Ç–∞–∫—Ç —Å—Ç–∞—î is_default=true
```

### 2. –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–æ–≤–Ω–æ–≥–æ —ñ–º–µ–Ω—ñ

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `EditFullNameForm`

**–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:**

1. –ë–∞—á–∏—Ç—å –ø–æ—Ç–æ—á–Ω–µ —ñ–º'—è –≤ Input
2. –ó–º—ñ–Ω—é—î —ñ–º'—è ‚Üí –∑'—è–≤–ª—è—î—Ç—å—Å—è –∑–µ–ª–µ–Ω–∞ –≥–∞–ª–æ—á–∫–∞ (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è)
3. –ù–∞—Ç–∏—Å–∫–∞—î "–ó–±–µ—Ä–µ–≥—Ç–∏"
4. UI –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –º–∏—Ç—Ç—î–≤–æ —á–µ—Ä–µ–∑ callback

**–¢–µ—Ö–Ω—ñ—á–Ω–∏–π flow:**

```
EditFullNameForm
  ‚Üì (submit)
updateFullNameAction
  ‚Üì (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è Zod)
updateUserDataFullName(userId, fullName)
  ‚Üì (—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ë–î)
UPDATE user_data SET full_name = $1 WHERE user_id = $2
  ‚Üì (—Ç—Ä–∏–≥–≥–µ—Ä)
trg_user_data_bu_set_updated_at ‚Üí updated_at = NOW()
  ‚Üì (callback)
onNameUpdated() ‚Üí loadData() ‚Üí setState ‚Üí re-render
```

### 3. –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `AddContactForm`

**–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:**

1. –í–≤–æ–¥–∏—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—É
2. –í–∏–±–∏—Ä–∞—î —Ç–∏–ø(–∏) —á–µ—Ä–µ–∑ toggle-–∫–Ω–æ–ø–∫–∏
3. –ù–∞—Ç–∏—Å–∫–∞—î "+"
4. –ö–æ–Ω—Ç–∞–∫—Ç –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫—É –º–∏—Ç—Ç—î–≤–æ

**–¢–µ—Ö–Ω—ñ—á–Ω–∏–π flow:**

```
AddContactForm
  ‚Üì (submit)
addContactAction
  ‚Üì (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è)
createUserContact() –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–∏–ø—É
  ‚Üì (—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ë–î)
INSERT INTO user_contact (is_default=false)
  ‚Üì (—Ç—Ä–∏–≥–≥–µ—Ä)
fn_user_contact_bi_validate() ‚Üí –≤–∞–ª—ñ–¥–∞—Ü—ñ—è —Ñ–æ—Ä–º–∞—Ç—É
  ‚Üì (callback)
onContactAdded() ‚Üí loadData() ‚Üí setState ‚Üí re-render
```

### 4. –ó–º—ñ–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `PersonalDataSection`

**–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:**

1. –ë–∞—á–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–∏ –∑ —ñ–∫–æ–Ω–∫–æ—é —Å–µ—Ä–¥–µ—á–∫–∞
2. –ñ–æ–≤—Ç–µ —Å–µ—Ä–¥–µ—á–∫–æ = –ø–æ—Ç–æ—á–Ω–∏–π –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π
3. –ù–∞—Ç–∏—Å–∫–∞—î –Ω–∞ —Å—ñ—Ä–µ —Å–µ—Ä–¥–µ—á–∫–æ —ñ–Ω—à–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É
4. –°–µ—Ä–¥–µ—á–∫–æ —Å—Ç–∞—î –∂–æ–≤—Ç–∏–º –º–∏—Ç—Ç—î–≤–æ

**–¢–µ—Ö–Ω—ñ—á–Ω–∏–π flow:**

```
handleSetDefault(contactId)
  ‚Üì
setDefaultContactAction
  ‚Üì
setDefaultContact(userId, contactId)
  ‚Üì (—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ë–î)
BEGIN
  UPDATE user_contact SET is_default = true WHERE id = $1
COMMIT
  ‚Üì (—Ç—Ä–∏–≥–≥–µ—Ä BEFORE UPDATE)
fn_user_contact_bu_maintain_default()
  ‚Üí UPDATE —ñ–Ω—à—ñ –∫–æ–Ω—Ç–∞–∫—Ç–∏ SET is_default = false
  ‚Üì (—Ç—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
trg_user_contact_bu_set_updated_at ‚Üí updated_at = NOW()
  ‚Üì (callback)
loadData() ‚Üí setState ‚Üí re-render
```

### 5. –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—É

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `PersonalDataSection`

**–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:**

1. –ù–∞—Ç–∏—Å–∫–∞—î —ñ–∫–æ–Ω–∫—É –∫–æ—Ä–∑–∏–Ω–∏
2. –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î –≤–∏–¥–∞–ª–µ–Ω–Ω—è
3. –ö–æ–Ω—Ç–∞–∫—Ç –∑–Ω–∏–∫–∞—î –º–∏—Ç—Ç—î–≤–æ

**–¢–µ—Ö–Ω—ñ—á–Ω–∏–π flow:**

```
handleDelete(contactId)
  ‚Üì (confirm dialog)
deleteContactAction
  ‚Üì
deleteUserContact(userId, contactId)
  ‚Üì (—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ë–î)
BEGIN
  DELETE FROM user_contact WHERE id = $1 AND user_id = $2
COMMIT
  ‚Üì (—Ç—Ä–∏–≥–≥–µ—Ä AFTER DELETE - —è–∫—â–æ –≤–∏–¥–∞–ª–∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π)
fn_user_contact_aid_maintain_default()
  ‚Üí –ø—Ä–∏–∑–Ω–∞—á–∞—î —ñ–Ω—à–∏–π –∫–æ–Ω—Ç–∞–∫—Ç is_default = true
  ‚Üì (callback)
loadData() ‚Üí setState ‚Üí re-render
```

---

## üé® UI/UX –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ

### –í–∞–ª—ñ–¥–∞—Ü—ñ—è "–Ω–∞ –ª—å–æ—Ç—É"

- –ó–µ–ª–µ–Ω–∞ –≥–∞–ª–æ—á–∫–∞ ‚úì –∑'—è–≤–ª—è—î—Ç—å—Å—è –ø—Ä–∏ –≤–∞–ª—ñ–¥–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–Ω—ñ
- –ß–µ—Ä–≤–æ–Ω–∏–π border –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ (—Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è submit)
- –ü–æ–º–∏–ª–∫–∏ –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è –≤ `ProfileAlert` –≤–≥–æ—Ä—ñ —Ñ–æ—Ä–º–∏

### Toggle –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–∏–ø—ñ–≤ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤

- –Ü–∫–æ–Ω–∫–∏ –∑ Lucide React
- –ó–µ–ª–µ–Ω–∏–π –∫–æ–ª—ñ—Ä –∞–∫—Ç–∏–≤–Ω–æ—ó —ñ–∫–æ–Ω–∫–∏
- Tooltip –∑ –Ω–∞–∑–≤–æ—é —Ç–∏–ø—É
- –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∏–±–æ—Ä—É –∫—ñ–ª—å–∫–æ—Ö —Ç–∏–ø—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ
- Phone –∑–∞–≤–∂–¥–∏ –≤–∏–±—Ä–∞–Ω–∏–π –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

### shadcn UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

- **Item** - –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤ (–∑–∞–º—ñ—Å—Ç—å —Å–∞–º–æ–ø–∏—Å–Ω–∏—Ö div)
- **Card** - –¥–ª—è –±–ª–æ–∫—ñ–≤
- **Button** - –¥–ª—è –≤—Å—ñ—Ö –∫–Ω–æ–ø–æ–∫
- **Input** - –¥–ª—è –ø–æ–ª—ñ–≤ –≤–≤–æ–¥—É
- **ToggleGroup** - –¥–ª—è –≤–∏–±–æ—Ä—É —Ç–∏–ø—ñ–≤

### –ú–∏—Ç—Ç—î–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI

- –ü—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `loadData()`
- –î–∞–Ω—ñ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ Server Actions
- –õ–æ–∫–∞–ª—å–Ω–∏–π state –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è
- –ñ–æ–¥–Ω–∏—Ö –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å —Å—Ç–æ—Ä—ñ–Ω–∫–∏

---

## üîê –í–∞–ª—ñ–¥–∞—Ü—ñ—è

### Frontend (Zod)

**–ü–æ–≤–Ω–µ —ñ–º'—è:**

```typescript
fullNameSchema = z
  .string()
  .min(2, '–ú—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏')
  .max(100, '–ú–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª—ñ–≤')
  .regex(UkrFullName, '–¢—ñ–ª—å–∫–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –∫–∏—Ä–∏–ª–∏—Ü—è')
  .refine((val) => val.trim().length >= 2, '–ù–µ —Ç—ñ–ª—å–∫–∏ –ø—Ä–æ–±—ñ–ª–∏');
```

**–ö–æ–Ω—Ç–∞–∫—Ç–∏:** –¥–∏–Ω–∞–º—ñ—á–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É

- phone: `REG_PHONE` (E.164-–ø–æ–¥—ñ–±–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç)
- email: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π regex
- telegram: –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É / @username / t.me/username
- viber: –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É / viber.com/username
- whatsapp: –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É / wa.me/–Ω–æ–º–µ—Ä

### Backend (PostgreSQL —Ç—Ä–∏–≥–≥–µ—Ä–∏)

–¢—Ä–∏–≥–≥–µ—Ä `fn_user_contact_bi_validate()` –ø–µ—Ä–µ–≤—ñ—Ä—è—î:

- –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–∞–∫—Ç—É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Ç–∏–ø—É
- –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ç–∏–ø—É –∫–æ–Ω—Ç–∞–∫—Ç—É
- –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–Ω–∞—á–µ–Ω–Ω—è (trim)

---

## üöÄ –ö–ª—é—á–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è

### 1. –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –¥–ª—è –≤—Å—ñ—Ö –∑–º—ñ–Ω

–ö–æ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∑ INSERT/UPDATE/DELETE –æ–±–≥–æ—Ä–Ω—É—Ç–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é:

```typescript
const client = await pool.connect();
try {
  await client.query('BEGIN');
  // ... SQL –æ–ø–µ—Ä–∞—Ü—ñ—ó
  await client.query('COMMIT');
} catch (error) {
  await client.query('ROLLBACK');
  throw error;
} finally {
  client.release();
}
```

### 2. BEFORE UPDATE —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É

–ó–∞–º—ñ—Å—Ç—å –¥–≤–æ—Ö UPDATE –∑–∞–ø—Ä–æ—Å—ñ–≤ –≤ –∫–æ–¥—ñ:

```sql
-- BEFORE UPDATE –∑–Ω—ñ–º–∞—î is_default –∑ —ñ–Ω—à–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤
-- –î–û –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ unique index ‚Üí —É–Ω–∏–∫–∞—î race condition
CREATE TRIGGER trg_user_contact_bu_maintain_default
BEFORE UPDATE ON mx_data.user_contact
```

### 3. Callback-—Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI

–ó–∞–º—ñ—Å—Ç—å `router.refresh()`:

```typescript
// Parent –ø–µ—Ä–µ–¥–∞—î loadData —è–∫ callback
<AddContactForm onContactAdded={loadData} />

// Child –≤–∏–∫–ª–∏–∫–∞—î callback –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó
if (result.status === 'success') {
  await onContactAdded(); // ‚Üí loadData() ‚Üí setState
}
```

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ `updated_at` —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä

–ù–µ –ø–∏—à–µ–º–æ `updated_at = NOW()` –≤ –∫–æ–¥—ñ - —Ü–µ —Ä–æ–±–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä:

```sql
CREATE TRIGGER trg_user_contact_bu_set_updated_at
BEFORE UPDATE ON mx_data.user_contact
EXECUTE FUNCTION mx_global.set_updated_at();
```

---

## üìù –ú—ñ–≥—Ä–∞—Ü—ñ—è –ë–î

–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∏:

```bash
psql -h localhost -U postgres -d maxsa_dev -f sql/mx-data/user-contact-fn.sql
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ–≤–Ω—ñ—Å—Ç—é —Ä–æ–±–æ—á–∏–π —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏:

- ‚úÖ –ü–µ—Ä–≤–∏–Ω–Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
- ‚úÖ –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —ñ–º–µ–Ω—ñ
- ‚úÖ –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤
- ‚úÖ –ó–º—ñ–Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É
- ‚úÖ –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤
- ‚úÖ –ú–∏—Ç—Ç—î–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI
- ‚úÖ –¶—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö (—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó)
- ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–∞ –≤—Å—ñ—Ö —Ä—ñ–≤–Ω—è—Ö
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ (data/actions —Ä–æ–∑–¥—ñ–ª–µ–Ω—ñ)
