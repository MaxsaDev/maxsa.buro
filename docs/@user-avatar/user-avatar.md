# Редагування аватара користувача

## Огляд

Система управління аватаром користувача дозволяє завантажувати, замінювати та видаляти аватар з автоматичним збереженням файлів в Amazon S3 та синхронізацією з базою даних.

## Архітектура

### Компоненти

- **`AvatarEditor`** (`components/profile/avatar-editor.tsx`) - клієнтський компонент для редагування аватара
- **`uploadAvatarAction`** (`actions/profile/avatar.ts`) - server action для завантаження аватара
- **`deleteAvatarAction`** (`actions/profile/avatar.ts`) - server action для видалення аватара
- **`updateUserImage`** (`data/auth/user.ts`) - функція для оновлення поля `image` в БД
- **`buildAvatarUrl`** (`lib/avatar/build-avatar-url.ts`) - утиліта для формування повного URL аватара

### Схема даних

- **БД**: Поле `image` в таблиці `public."user"` зберігає відносний шлях (наприклад: `/avatars/user_id/filename.jpg`)
- **S3**: Файли зберігаються за шляхом `avatars/{user_id}/{filename}`
- **URL**: Повний URL формується через `buildAvatarUrl()`: `{AWS_S3_STORAGE_URL}{image_path}`

## Золотий шлях (Happy Path)

### 1. Завантаження нового аватара

**Користувач:**

1. Відкриває сторінку профілю (Tab "Огляд")
2. Наводить курсор на аватар (або fallback з ініціалами)
3. Бачить overlay з іконкою камери
4. Клікає на іконку камери
5. Вибирає файл зображення (JPEG, PNG, WebP, GIF, до 5 МБ)
6. Бачить preview вибраного файлу з кнопками "Завантажити" та "Скасувати"
7. Клікає "Завантажити"
8. Бачить toast-повідомлення про успіх
9. Сторінка автоматично перезавантажується
10. Бачить новий аватар замість fallback

**Система:**

1. Валідує файл на клієнті (розмір, формат)
2. Створює preview через FileReader
3. При підтвердженні відправляє FormData на сервер
4. Server action валідує файл на сервері
5. Читає актуальні дані користувача з БД (обходить кеш Better Auth)
6. Конвертує файл в Buffer
7. Нормалізує та транслітерує ім'я файлу
8. Формує шлях: `avatars/{user_id}/avatar-{user_id}-{timestamp}.{ext}`
9. Завантажує файл в S3
10. Оновлює поле `image` в БД (відносний шлях)
11. Видаляє старий файл з S3 (якщо існував)
12. Ревалідує `/profile` та `/(protected)` layout
13. Повертає успішний результат
14. Клієнт перезавантажує сторінку (`window.location.reload()`)
15. Layout читає актуальні дані з БД (обходить кеш Better Auth)
16. Аватар відображається з повним URL через `buildAvatarUrl()`

### 2. Заміна існуючого аватара

**Користувач:**

1. Відкриває сторінку профілю
2. Наводить курсор на існуючий аватар
3. Бачить overlay з іконками камери та кошика
4. Клікає на іконку камери
5. Вибирає новий файл
6. Бачить preview нового файлу
7. Клікає "Завантажити"
8. Бачить toast-повідомлення про успіх
9. Сторінка перезавантажується
10. Бачить новий аватар замість старого

**Система:**

1. Виконує той самий процес, що й при завантаженні
2. Додатково видаляє старий файл з S3 перед завантаженням нового

### 3. Видалення аватара

**Користувач:**

1. Відкриває сторінку профілю
2. Наводить курсор на аватар
3. Бачить overlay з іконками камери та кошика
4. Клікає на іконку кошика
5. Бачить діалог підтвердження "Видалити аватар?"
6. Підтверджує видалення
7. Бачить toast-повідомлення про успіх
8. Сторінка перезавантажується
9. Бачить fallback з ініціалами замість аватара

**Система:**

1. Читає актуальні дані користувача з БД
2. Перевіряє наявність аватара
3. Видаляє файл з S3
4. Оновлює поле `image` в БД на `null`
5. Ревалідує сторінки
6. Повертає успішний результат
7. Клієнт перезавантажує сторінку
8. Layout читає `image: null` з БД
9. Відображається fallback

## Технічні деталі

### Обхід кешу Better Auth

Better Auth кешує дані користувача в cookieCache на 5 хвилин. Для отримання актуальних даних про аватар:

- **В layout**: Читаємо `image` напряму з БД через `getUserById()` замість `getCurrentUser()`
- **В server actions**: Читаємо актуальні дані з БД перед операціями

### Формування URL

Відносний шлях з БД (`/avatars/user_id/filename.jpg`) перетворюється в повний URL через утиліту `buildAvatarUrl()`:

```typescript
buildAvatarUrl('/avatars/user123/avatar.jpg');
// → 'https://maxsa-soft.s3.eu-north-1.amazonaws.com/avatars/user123/avatar.jpg'
```

### Валідація файлів

**На клієнті:**

- Розмір: до 5 МБ
- Формати: JPEG, JPG, PNG, WebP, GIF

**На сервері:**

- Дублюється валідація для безпеки
- Декодування імені файлу (виправлення кодування кирилиці)
- Нормалізація та транслітерація імені файлу

### Структура файлів в S3

```
avatars/
  └── {user_id}/
      └── avatar-{user_id}-{timestamp}.{ext}
```

Приклад: `avatars/OokxeVHaz29ZU9DbRCmaiJqxL3eYah4V/avatar-ookxevhaz29zu9dbrcmaijqxl3eyah4v-1764319176876.jpg`

### Оновлення UI

Після успішних операцій використовується `window.location.reload()` для повного оновлення сторінки, що гарантує:

- Оновлення сесії Better Auth
- Оновлення даних користувача в layout
- Оновлення аватара в sidebar та профілі

## Використання

### В компонентах

```tsx
import { AvatarEditor } from '@/components/profile/avatar-editor';

<AvatarEditor
  imageUrl={user.image} // Відносний шлях з БД або null
  userName={user.name}
  size="lg"
  editable
/>;
```

### Формування URL для відображення

```tsx
import { buildAvatarUrl } from '@/lib/avatar/build-avatar-url';

const avatarUrl = buildAvatarUrl(user.image);
// Повертає повний URL або null
```

## Обробка помилок

- **Валідація на клієнті**: Toast-повідомлення про помилку
- **Помилки завантаження в S3**: Логування в консоль, повернення помилки користувачу
- **Помилки видалення з S3**: Логування, продовження видалення з БД
- **Помилки оновлення БД**: Rollback транзакції, повернення помилки

## Залежності

- `@aws-sdk/client-s3` - для роботи з Amazon S3
- `normalizeAndTransliterate` - для нормалізації імен файлів
- `revalidatePath` - для оновлення кешу Next.js

## Конфігурація

Необхідні змінні середовища:

```env
NEXT_AWS_S3_REGION=eu-north-1
NEXT_AWS_S3_ACCESS_KEY_ID=your_access_key
NEXT_AWS_S3_SECRET_ACCESS_KEY=your_secret_key
NEXT_AWS_S3_BUCKET_NAME=maxsa-soft
```

Константа URL (для клієнтських компонентів):

```typescript
export const AWS_S3_STORAGE_URL = 'https://maxsa-soft.s3.eu-north-1.amazonaws.com';
```
